apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: kube-prometheus-stack
  namespace: argocd
  annotations:
    # Deploy after CRDs are in place
    argocd.argoproj.io/sync-wave: "0"
spec:
  project: observability
  source:
    repoURL: https://prometheus-community.github.io/helm-charts
    chart: kube-prometheus-stack
    targetRevision: 72.6.2
    helm:
      # CRDs are managed by the prometheus-crds application
      skipCrds: true
      values: |
        # Prometheus configuration
        prometheus:
          prometheusSpec:
            retention: 15d
            storageSpec:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 20Gi
            # Resource limits
            resources:
              requests:
                memory: 512Mi
                cpu: 250m
              limits:
                memory: 2Gi
                cpu: 1000m

        # Grafana configuration
        grafana:
          # No ingress - accessed via port-forward
          ingress:
            enabled: false
          # Admin credentials from Vault
          admin:
            existingSecret: grafana-admin-credentials
            userKey: admin-user
            passwordKey: admin-password
          persistence:
            enabled: true
            type: pvc
            storageClassName: longhorn
            accessModes:
              - ReadWriteOnce
            size: 2Gi
          # Pre-configure Loki as a datasource
          additionalDataSources:
            - name: Loki
              type: loki
              url: http://loki.monitoring.svc.cluster.local:3100
              access: proxy
              isDefault: false
          # Resource limits
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 512Mi
              cpu: 500m

        # Alertmanager configuration
        alertmanager:
          alertmanagerSpec:
            storage:
              volumeClaimTemplate:
                spec:
                  storageClassName: longhorn
                  accessModes: ["ReadWriteOnce"]
                  resources:
                    requests:
                      storage: 2Gi

        # Prometheus Operator configuration
        prometheusOperator:
          admissionWebhooks:
            # Avoid webhook issues during initial deployment
            failurePolicy: Ignore
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
  # Ignore differences that ArgoCD would otherwise constantly try to reconcile
  ignoreDifferences:
    - group: ""
      kind: Service
      jqPathExpressions:
        - .metadata.labels."app.kubernetes.io/instance"
    - group: apps
      kind: Deployment
      jqPathExpressions:
        - .spec.template.metadata.annotations
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[].clientConfig.caBundle
